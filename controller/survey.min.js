'use strict';const express=require("express"),app=express(),router=express.Router(),mailTemplate=require("../services/mailTemplate"),Survey=require("../model/Survey"),auth=require("../config/authenticate"),User=require("../model/User");router.get("/",(a,d)=>{Survey.find({user:a.user}).then(b=>{d.status(202).json({surveys:b})}).catch(b=>console.log(b))});
router.post("/",auth,(a,d)=>{a.body.title&&a.body.subject&&a.body.body&&a.body.recipients?User.findById(a.user._id).then(b=>{if(1>b.credit)return d.status(402).json({error:"Survey not sent. Low on credits. Credit now!!"});const c=new Survey;c.title=a.body.title;c.subject=a.body.subject;c.body=a.body.body;c.recipients=a.body.recipients.split(",").map(e=>({email:e}));c.user=a.user;c.dateSent=Date.now();try{c.save().then(e=>{--b.credit;b.save().then(f=>{d.status(202).json({user:b})}).catch(f=>console.log(f))}).catch(e=>
console.log(e))}catch(e){d.status(402).json({error:"An error occurred!"})}}).catch(b=>console.log(b)):d.status(402).json({error:"Field(s) can not be empty"})});router.delete("/delete",(a,d)=>{Survey.findOne({id:a.body.id}).then(b=>{b.delete().then(c=>{d.status(200).json({response:c})}).catch(c=>console.log(c))}).catch(b=>console.log(b))});router.post("/webhooks",(a,d)=>{console.log(a.body);d.send({})});
router.post("/search",(a,d)=>{console.log(".......receiving");const b=new RegExp(a.body.search,"i");Survey.find({$or:[{title:b}]}).then(c=>{1<c.length?(d.json({surveys:c}),console.log(c)):Survey.findOne({$or:[{title:b}]}).then(e=>{d.json({survey:e});console.log(e)}).catch(e=>console.log(e))}).catch(c=>console.log(c))});module.exports=router;